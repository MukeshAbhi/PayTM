FROM node:20-slim

# Enable pnpm via corepack
RUN apt-get update && apt-get install -y curl && \
    corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

# Copy root config files for dependency resolution
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./

# Copy the rest of the monorepo
COPY apps ./apps
COPY packages ./packages

# Install dependencies (include devDependencies for build)
RUN pnpm install

# Generate Prisma client (if used)
RUN pnpm generate:db

# Build the Next.js app using pnpm exec to ensure binaries work
RUN pnpm --filter @repo/user build

# Start the app
CMD ["pnpm", "start-user-app"]
